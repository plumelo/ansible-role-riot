---

- name: Install synapse
  pip:
    name: '{{ synapse_repo }}'
    virtualenv: '{{ synapse_virtualenv }}'
  become: true
  become_user: '{{ riot_user }}'

- name: Generate homeserver config file
  # yamllint disable-line rule:line-length
  shell: '. bin/activate && python -m synapse.app.homeserver --server-name {{ synapse_hostname }} --config-path homeserver.yaml --generate-config --report-stats=yes'
  args:
    chdir: '{{ synapse_virtualenv }}'
    creates: '{{ synapse_virtualenv }}/homeserver.yaml'
  become: true
  become_user: '{{ riot_user }}'

- name: Configure homeserver
  template:
    src: homeserver.yaml.j2
    dest: '{{ synapse_virtualenv }}/homeserver.yaml'
  with_items:
    - '{{ synapse_config }}'
  become: true
  become_user: '{{ riot_user }}'

- name: Configure homeserver log
  template:
    src: logging.yaml.j2
    dest: '{{ synapse_virtualenv }}/logging.yaml'
  become: true
  become_user: '{{ riot_user }}'
